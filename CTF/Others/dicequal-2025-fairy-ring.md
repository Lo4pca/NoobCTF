# [fairy-ring](https://priv.pub/posts/dicectf-2025-quals)

有生之年能看懂吗……

看这篇wp前还得先把这篇看懂： https://priv.pub/posts/rainbow-attack

这是一个关于有限域 $F_q$ 上一个多元二次函数（multivariate quadratic，MQ）的故事。MQ是一个n变量的多项式，其中每一项的次数最大为2。多元二次映射（multivariate quadratic map） $F:F_q^n\rightarrow F_q^m$ 则是m个这样的二次方程的集合；其中 $F(x)=y$ 等于下方的映射：

$x=(x_1,...x_n)\rightarrow y=(f_1(x_1,...,x_n),...,f_m(x_1,...,x_n))$

给定任意F和t，寻找 $F(s)=t$ 的解的难度是NP-hard。这说明MQ是一个不错的单向函数。于是便有了一个签名方案的想法：设计一个映射P（公钥）和一个陷门（trapdoor，私钥）；将要签名的信息hash成一个向量t，采样其原像s使得 $P(s)=t$ ，作为其签名结果

unbalanced oil and vinegar (UOV)签名方案基于这样一个事实：某些多元二次映射容易求逆。比如这个： $f(s)=\Sigma_j\Sigma_{k > m}\alpha_{jk}s_js_k$ 。把它展开就能发现，无论在多项式的哪一项， $s_1,...s_m$ 变量均只出现一次(没有任何一项会同时包含两个 $s_1,...s_m$ 里的变量)。所以我们可以说F在这些变量上是线性的。求解F(s)=t时，只需要固定 $s_{m+1},...s_n$ 的值就能像解线性方程一样解出 $s_1,...s_m$ 。如果随机选择的值得不出解，换一组值即可

但是F实在是太好逆了，需要引入陷门使得这玩意对于不知道陷门的群体来说不好逆。引入可逆线性映射 $\tau$ ，公钥为两者的复合函数 $P=F\circ\tau$ (先应用 $\tau$ 再应用F)，私钥为P的分解结果。签名t需要求解F(s)=t,然后将 $\tau^{-1}(s)$ 作为签名结果

rainbow是UOV的变种，据说可以提升抵抗代数攻击（如 Gröbner 基攻击）的能力，减少公钥的大小。主要思路是将前m个变量的求解分成两个部分。选定 $o_2$ 满足 $0 < o_2 < m$ ，考虑具有如下形式的二次方程的F：

$f(s)=\Sigma_j\Sigma_{k > o_2}\alpha_{jk}s_js_k$ , $f(s)=\Sigma_{j > o_2}\Sigma_{k > m}\alpha_{jk}s_js_k$

求解F(s)=t时，先固定 $s_{m+1},...,s_n$ ，于是后面的二次方程就变成线性的了，能够求出 $s_{o_2+1},...,s_m$ 。同理，第一个二次方程也变成线性的了，能够求出 $s_1,...,s_{o_2}$ 。和UOV一样，最后找个可逆线性映射与F结合得到公钥P

一个多变量二次函数可以写为 $f(x)=x^TAx+b^Tx+c$ （A为矩阵，b为向量）形式。于是有 $x^T(A+A^T)y=f(x+y)−f(x)−f(y)+c$ ,为F的极坐标形式（polar form）： $F'(x,y):=F(x+y)−F(x)−F(y)+F(0)$ 。F'是一个双线性（bilinear）函数，即它在x和y上都是线性的。F(0)固定为0，所以后续可以直接丢掉。提这个完全是因为接下来要看UOV和rainbow的另一个定义

对于一个公钥函数P，陷门是一个 $F_q^n$ 中的m维线性子空间O，满足P消失于O（P vanishes on O），即 $P(o)=0,\forall o\in O$ 。求t的原像时需要随机固定向量 $v\in F^n_q$ ，然后找一个 $o\in O$ 使得 $t=P(v+o)=P'(v,o)+P(v)+P(o)$ （v+o等于 $P^{-1}(t)$ ）。因为P'是双线性函数，P(v)是常量，P(o)=0，所以这个方程是线性的

考虑第一个定义里提到的容易逆向的F。它的“容易逆向”基于它的陷门结构：所有后n−m个分量为0的向量集合，即 span{ $e_1,...e_m$ } ，形成一个m维向量子空间O。前m个变量被称为oil，可变；后n-m个变量为vinegar，固定。第一个定义里的固定vinegar等同于第二个定义里固定向量v，其前m个分量为0；求oil变量等同于解出 $o\in O$

这里我得停下来理一下思路。对于 $f(s)=\Sigma_j\Sigma_{k > m}\alpha_{jk}s_js_k$ 这个函数，如果给定t求满足f(s)=t的s，难度为NP-hard。陷门在于f的构造本身。f的构造使得我们可以将s拆成两部分，以m为分界线，前m个变量为oil，后n-m个变量为vinegar。所有oil变量自己组成一个m维的向量子空间，即前m个分量为有限域中的任意值，后n-m个分量固定为0。我一直苦于无法将UOV的两个定义联系起来。因为第二个定义中“莫名其妙”冒出来了一个O，后续定义围绕“从O找找出满足条件的o”；而第一个定义似乎是“固定v求解o”。于是我的疑惑是“第一个定义中求出的o一定在第二个定义的O里吗“？后面发现是我下意识把O的结构看的太复杂了。满足F(O)=0的线性子空间O完全没有任何复杂条件；由于F的特殊构造，只需要后n-m个分量为0，前m个分量的值根本就不重要。所以第一个定义中的“固定v”隐含了一个条件，就是“不碰o”。所以根本不是“求解o”，而是和第二个定义里一样，在O找到满足条件的o，使得o和v拼在一起满足F(o+v)=t的条件。将s拆分成o和v也很自然，因为o是前m个分量随意，后n-m个分量为0；v是反过来

现在引入极化形式。我不确定是怎么从上述内容联想到极化形式的，可能是上述的拆分和F(O)=0放到极化形式里有妙用？ $F'(o,v):=F(o+v)−F(o)−F(v)+F(0)$ 。x和y都很容易找到对应，就是o和v。F(0)=0没啥好说的;F(o)=0也是上面已经知道的结果。如果再结合签名目标F(o+v)=t，就有了 $t=F'(o,v)+F(v)$ 。v固定了所以F(v)是个常量，F'(o,v)在v固定的情况下是线性方程。于是将难解的F(s)=t转成了求解较容易的极化方程。当然F的这个陷门不完全等于公钥P的陷门。不过P也只是F加个 $\tau$ ，套一层 $\tau^{-1}$ 就能在P上用上述陷门了

rainbow的构造和UOV类似。有一个 $O_1=$ span { $e_1,...,e_m$ }，但这个子空间并不是消失子空间（vanishing subspace）。因为rainbow的拆分结构，真正的消失子空间是前 $o_2$ 个oil变量张成的空间 $O_2=$ span { $e_1,...,e_{o_2}$ }。对于任意 $o_1\in O_1$ ，F可以将 $o_1$ 送到后 $m-o_2$ 个分量为零的向量。换句话说，假设W是前 $o_2$ 标准基张成的空间，在商空间 $F^m_q/W$ 下 $O_1$ 可以被看作是消失子空间。这里 $o_2$ 是输入空间，W是输出空间，满足 $F(o_2)\in W,\forall o_2\in O_2$ 。这意味着所有来自 $O_2$ 的元素经映射后只会影响输出向量的前 $o_2$ 个分量

补一下商空间的概念。商空间V/W={v+W | $v\in V$ }。其中v+W是集合加法,v+W:={ $v+w|w\in W$ }。我的理解是这样的：假如从原空间V取出两个元素，如果两者的差值是一个W中的向量，则两者是同一个元素。这是因为两个元素的差别仅在W中展现，而商空间的定义就是模掉这个空间，所以忽略它们在W上的差别。通俗地理解，模掉W等同于"零化"，"无效化"原空间元素在W上的延伸。除了上述内容，如果从原空间V中选出一个W里的元素，那么这个元素在商空间V/W里被看作是零

求t的原像首先也是要固定一个随机向量 $v\in F^n_q$ ，然后找到一个满足陪集 $F(v+o_1)+W$ 和t+W相等的 $o_1\in O_1$ 。在商空间W下， $a+W=b+W\Leftrightarrow a-b\in W$ 。找完满足条件的 $o_1$ 后找 $o_2$ ，使 $t=F((v+o_1)+o_2)=F'(v+o_1,o_2)+F(v+o_1)+F(o_2)=F'(v+o_1,o_2)+F(v+o_1)$ 。可以证明这个方程的两个部分， $F'(v+o_1,o_2)$ 和 $F(v+o_1)$ 都在W里。后者已经知道了，而前者需要证明：取任意 $x\in F^n_q,o_2\in O_2$ ， $F'(x,o_2)$ 一定在W里。将 $F'(x,o_2)$ 展开可以得到 $F(x+o_2)-F(x)$ 。因 $o_2$ 只会影响输出向量的前 $o_2$ 个分量（我突然意识到我符号用得很乱，这里的两个 $o_2$ 含义不同，前者是 $O_2$ 里的元素，后者是数量），所以 $F(x+o_2)-F(x)$ 必定只有前 $o_2$ 个分量不是零，即在W中